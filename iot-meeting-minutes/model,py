# adaptive_t5_summarizer.py
from transformers import AutoTokenizer, AutoModelForSeq2SeqLM
import torch
import math

# ====== CONFIG ======
MODEL_NAME = "t5-small"
MAX_INPUT_TOKENS = 512
BASE_SUMMARY_RATIO = 3.5     # roughly 1/3.5 of original
OVERLAP_RATIO = 0.15         # 15% overlap between chunks
DEVICE = "cuda" if torch.cuda.is_available() else "cpu"

# ====== LOAD MODEL ======
tokenizer = AutoTokenizer.from_pretrained(MODEL_NAME)
model = AutoModelForSeq2SeqLM.from_pretrained(MODEL_NAME).to(DEVICE)

# ====== CLEANUP ======
def clean_text(text):
    return " ".join(text.strip().split())

# ====== CHUNKER WITH OVERLAP ======
def chunk_text(text, tokenizer, max_tokens=MAX_INPUT_TOKENS, overlap_ratio=OVERLAP_RATIO):
    words = text.split()
    chunks = []
    stride = int(len(words) * (1 - overlap_ratio))
    start = 0

    while start < len(words):
        chunk_words = words[start:start + stride]
        chunk_text = " ".join(chunk_words)
        tokens = tokenizer.encode(chunk_text, return_tensors="pt")
        if tokens.shape[1] > max_tokens:
            # reduce by half if still too long
            chunk_words = chunk_words[:int(len(chunk_words)/2)]
            chunk_text = " ".join(chunk_words)
        chunks.append(chunk_text)
        start += stride
        if start >= len(words):
            break
    return chunks

# ====== SUMMARIZATION FUNCTION ======
def summarize_text(text, model, tokenizer):
    input_text = f"summarize: {text}"
    tokenized = tokenizer.encode(input_text, return_tensors="pt", truncation=True, max_length=MAX_INPUT_TOKENS).to(DEVICE)

    # dynamic summary length based on input length
    input_len = tokenized.shape[1]
    max_output = min(256, max(60, int(input_len / BASE_SUMMARY_RATIO)))

    summary_ids = model.generate(
        tokenized,
        max_length=max_output,
        num_beams=4,
        early_stopping=True,
        no_repeat_ngram_size=3,
        length_penalty=1.0
    )
    summary = tokenizer.decode(summary_ids[0], skip_special_tokens=True)
    return summary

# ====== HIERARCHICAL SUMMARIZER ======
def hierarchical_summary(transcript):
    text = clean_text(transcript)
    chunks = chunk_text(text, tokenizer)

    print(f"ðŸ”¹ Split into {len(chunks)} chunks with overlap preservation")

    # Step 1: summarize each chunk
    partial_summaries = []
    for i, ch in enumerate(chunks):
        print(f"  Summarizing chunk {i+1}/{len(chunks)}...")
        partial_summary = summarize_text(ch, model, tokenizer)
        partial_summaries.append(partial_summary)

    # Step 2: combine and re-summarize if multiple chunks
    combined = " ".join(partial_summaries)
    if len(chunks) > 1:
        print("ðŸ”¹ Combining partial summaries and generating final summary...")
        final_summary = summarize_text(combined, model, tokenizer)
        return final_summary
    else:
        return partial_summaries[0]

# ====== TEST EXAMPLE ======
if __name__ == "__main__":
    meeting_transcript = """
    some are working on another project so my basic feel that everything can be represented in computers and computer can't replace your mind the main building block of it as building on your network that can understand like human brain but what happens is that day to day life most of people don't understand how to use biggest using it but the of yeah it's far more than that predicting day life to controlling it making it better the yeah will take us to a level there people who can make things hard for us the main thing that gets us power than the real question will happen stroke that was legal to well let me talk about that age just we are not very close but we are certainly close to what is correction of a human brain a computer much more faster much more better and efficient a label and can be transferred that can have a lot of memories performance basis so what i wanted to make this to make a needle lot of us computational power what actually is that train the data is one thing but making sense is another part of training at the first is trying that second insurance and third is running and generating answer model just understand that everything but what i'm proposing there i will use the randomness of universe to make this possible what is that lose the string theory of and relativity for make this happen la forma dynamics and this is far more capable than address quantum technology superficial speed this but that it can do a lot of more stuff that's normal the basic things where we are lacking is the computational power that is also we are able to do using like it's one hundred of and videos performance of these increasing day by day so the competition expensive thing can be done in less time on all the cube it's well known that quantum computer as microsoft has so they have make their wasn't of quantum computers that have a lot of power than other traditional computational power so they can do a lot of stuff that what you want to do is that technology for betterment of society right now we are a lot of things that are not making sense but by the time it will become great so we can visit is the coming age is going to be ruled by a board robots and stuff like that there is a person for me if you are into these then start working right now much time either so that more and also when he should learn like a child robert of its talk about something interesting like how of human brain walk the consciousness how is not just random of chaos whatever happens in universe is part of world part of us maybe more than that murder was let's talk about something else i'll talk about how medical i am too much about changing technology most people don't do it for sake of earning money and all but i want to do it for changing the ground breaking varieties my aim is very how i want to do it on time so you make short i can do it and do it that's the most thing okay i think the sector is fine talk about so thank you bye okay let's stop move i want to see the capacity of this rewarding for the this fuss about some another topic so how's okay this fuss about politics all politics is always fall because of the way people assume at nothing oh and let's talk about geopolitics and how the world changed with how america and all the world's know fucking the global economy right now from you all know about it that day so much tariff on other countries because of they want to feel superior than others whatever they want but you're fifty sixty years that should get this always change no longer the number one countries china will become and eventually there were also and just go and declined because of nice things i've heard about so that will happen with them hope things happen and two yours and we can do that capitalize it by using our people rather than just building services for them build products for everyone your service based companies and all but that's not the time the product or company from the world that the world the genetic biotech will disrupt the market rather than just for dealing with this small service thanks and all these things are really automated right and also crucial role of person who have done research and work on it far more valuable than just have a degree and so super main objective is to make mine that can comprehend this all let's talk about some more interesting thing so i think what i can think of area so let's talk about how global warming government works on a basic principle of demand and supply have no what is that these demand and supply artificially created for some kind of are some kind of stress some kind of other third party activities which happen every day these are influenced by a lot of powerful people that they of from shadows you must think that tickets are also some conspiracy theories but i do believe that it's not just visa and all of us okay so what the time much better than the next final edit if you are so what is that i will deploy all the models on my raspberry pi work offline and decentralize happen on my local device that the main motive of making devices so i've almost for six and eight seconds that close to ten minutes and i would like to pause i am running out of thoughts but or something i forget what do you know exactly what isn't others i was very bad from school time i try to for some that in the college still not on the top so thank you

    """

    summary = hierarchical_summary(meeting_transcript)
    print("\n===== FINAL SUMMARY =====\n")
    print(summary)
